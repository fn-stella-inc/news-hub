---
// -- navbar component with search functionality
import { Search, X, FileText, ArrowRight } from 'lucide-astro';
---

<header class="navbar">
  <div class="navbar-container">
    <!-- -- logo/brand -->
    <a href="/" class="navbar-brand">
      <img src="/logo.webp" alt="" class="brand-logo" width="32" height="32" />
      <span class="brand-text">News Hub</span>
    </a>
    
    <!-- -- search trigger button -->
    <button 
      type="button" 
      class="search-trigger"
      id="search-trigger"
      aria-label="Open search"
      aria-haspopup="dialog"
    >
      <Search size={16} strokeWidth={2} />
      <span class="search-text">Search</span>
      <kbd class="search-shortcut">Ctrl K</kbd>
    </button>
  </div>
</header>

<!-- -- search modal -->
<div class="search-modal" id="search-modal" role="dialog" aria-modal="true" aria-label="Search articles">
  <div class="search-backdrop" id="search-backdrop"></div>
  <div class="search-content">
    <!-- -- search input -->
    <div class="search-input-wrapper">
      <Search size={20} strokeWidth={2} class="search-icon" />
      <input 
        type="text" 
        class="search-input" 
        id="search-input"
        placeholder="Search articles..."
        autocomplete="off"
        autofocus
      />
      <button type="button" class="search-close" id="search-close" aria-label="Close search">
        <X size={18} strokeWidth={2} />
      </button>
    </div>
    
    <!-- -- search results -->
    <div class="search-results" id="search-results">
      <div class="search-empty">
        <p>Type to search articles...</p>
      </div>
    </div>
    
    <!-- -- search footer -->
    <div class="search-footer">
      <div class="search-hint">
        <kbd>↑↓</kbd> to navigate
        <kbd>↵</kbd> to select
        <kbd>esc</kbd> to close
      </div>
    </div>
  </div>
</div>

<script>
  // -- search functionality
  const searchTrigger = document.getElementById('search-trigger');
  const searchModal = document.getElementById('search-modal');
  const searchBackdrop = document.getElementById('search-backdrop');
  const searchClose = document.getElementById('search-close');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const searchResults = document.getElementById('search-results');
  
  let articles: any[] = [];
  let selectedIndex = -1;
  
  // -- load articles data
  async function loadArticles() {
    try {
      const response = await fetch('/api/articles?category=all');
      const data = await response.json();
      articles = data.articles || [];
    } catch (error) {
      console.error('Failed to load articles:', error);
    }
  }
  
  // -- open search modal
  function openSearch() {
    searchModal?.classList.add('active');
    searchInput?.focus();
    document.body.style.overflow = 'hidden';
    selectedIndex = -1;
  }
  
  // -- close search modal
  function closeSearch() {
    searchModal?.classList.remove('active');
    if (searchInput) searchInput.value = '';
    if (searchResults) {
      searchResults.innerHTML = '<div class="search-empty"><p>Type to search articles...</p></div>';
    }
    document.body.style.overflow = '';
    selectedIndex = -1;
  }
  
  // -- search articles
  function searchArticles(query: string) {
    if (!query.trim()) {
      if (searchResults) {
        searchResults.innerHTML = '<div class="search-empty"><p>Type to search articles...</p></div>';
      }
      return;
    }
    
    const lowerQuery = query.toLowerCase();
    const results = articles.filter(article => 
      article.title.toLowerCase().includes(lowerQuery) ||
      article.excerpt.toLowerCase().includes(lowerQuery) ||
      article.category.toLowerCase().includes(lowerQuery) ||
      article.tags?.some((tag: string) => tag.toLowerCase().includes(lowerQuery))
    );
    
    renderResults(results);
  }
  
  // -- render search results
  function renderResults(results: any[]) {
    if (!searchResults) return;
    
    if (results.length === 0) {
      searchResults.innerHTML = '<div class="search-empty"><p>No articles found</p></div>';
      return;
    }
    
    const html = results.slice(0, 8).map((article, index) => `
      <a href="/news/${article.slug}" class="search-result-item" data-index="${index}">
        <div class="result-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
        </div>
        <div class="result-content">
          <span class="result-title">${article.title}</span>
          <span class="result-meta">${article.category} · ${article.readingTime} min read</span>
        </div>
        <div class="result-arrow">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        </div>
      </a>
    `).join('');
    
    searchResults.innerHTML = html;
    selectedIndex = -1;
  }
  
  // -- keyboard navigation
  function handleKeyNavigation(e: KeyboardEvent) {
    const items = searchResults?.querySelectorAll('.search-result-item');
    if (!items || items.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, 0);
      updateSelection(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      const selectedItem = items[selectedIndex] as HTMLAnchorElement;
      if (selectedItem) {
        window.location.href = selectedItem.href;
      }
    }
  }
  
  // -- update selection visual
  function updateSelection(items: NodeListOf<Element>) {
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.classList.add('selected');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('selected');
      }
    });
  }
  
  // -- event listeners
  searchTrigger?.addEventListener('click', openSearch);
  searchBackdrop?.addEventListener('click', closeSearch);
  searchClose?.addEventListener('click', closeSearch);
  
  searchInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    searchArticles(target.value);
  });
  
  searchInput?.addEventListener('keydown', handleKeyNavigation);
  
  // -- global keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // -- Ctrl+K or Cmd+K to open search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      if (searchModal?.classList.contains('active')) {
        closeSearch();
      } else {
        openSearch();
      }
    }
    
    // -- Escape to close
    if (e.key === 'Escape' && searchModal?.classList.contains('active')) {
      closeSearch();
    }
  });
  
  // -- load articles on page load
  loadArticles();
</script>

<style>
  /* -- navbar styles - light theme */
  .navbar {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--color-border);
  }
  
  .navbar-container {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: var(--space-sm) var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  /* -- brand styles */
  .navbar-brand {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    text-decoration: none;
  }
  
  .brand-logo {
    width: 32px;
    height: 32px;
    object-fit: contain;
  }
  
  .brand-text {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text-primary);
  }
  
  /* -- search trigger button */
  .search-trigger {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xs) var(--space-md);
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    color: var(--color-text-muted);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    min-width: 200px;
  }
  
  .search-trigger:hover {
    border-color: var(--color-border-hover);
    color: var(--color-text-secondary);
  }
  
  .search-text {
    flex: 1;
    text-align: left;
  }
  
  .search-shortcut {
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
    background-color: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--color-text-muted);
  }
  
  @media (max-width: 640px) {
    .search-trigger {
      min-width: auto;
      padding: var(--space-xs);
    }
    
    .search-text,
    .search-shortcut {
      display: none;
    }
  }
  
  /* -- search modal styles */
  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 10vh var(--space-lg) var(--space-lg);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
  }
  
  .search-modal.active {
    opacity: 1;
    visibility: visible;
  }
  
  .search-backdrop {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }
  
  .search-content {
    position: relative;
    width: 100%;
    max-width: 600px;
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-2xl);
    overflow: hidden;
    transform: translateY(-20px) scale(0.95);
    transition: transform var(--transition-base);
  }
  
  .search-modal.active .search-content {
    transform: translateY(0) scale(1);
  }
  
  /* -- search input */
  .search-input-wrapper {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-border);
  }
  
  .search-input-wrapper .search-icon {
    color: var(--color-text-muted);
    flex-shrink: 0;
  }
  
  .search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-family: var(--font-body);
    font-size: var(--text-lg);
    color: var(--color-text-primary);
    outline: none;
  }
  
  .search-input::placeholder {
    color: var(--color-text-muted);
  }
  
  .search-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    background-color: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .search-close:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }
  
  /* -- search results */
  .search-results {
    max-height: 400px;
    overflow-y: auto;
    padding: var(--space-sm);
  }
  
  .search-empty {
    padding: var(--space-xl);
    text-align: center;
    color: var(--color-text-muted);
  }
  
  .search-result-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-lg);
    text-decoration: none;
    transition: all var(--transition-fast);
  }
  
  .search-result-item:hover,
  .search-result-item.selected {
    background-color: var(--color-bg-secondary);
  }
  
  .result-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, rgba(221, 12, 240, 0.1), rgba(34, 211, 238, 0.1));
    border-radius: var(--radius-md);
    color: var(--color-accent-primary);
    flex-shrink: 0;
  }
  
  .result-content {
    flex: 1;
    min-width: 0;
  }
  
  .result-title {
    display: block;
    font-weight: 600;
    color: var(--color-text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .result-meta {
    display: block;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: capitalize;
  }
  
  .result-arrow {
    color: var(--color-text-muted);
    opacity: 0;
    transition: opacity var(--transition-fast);
  }
  
  .search-result-item:hover .result-arrow,
  .search-result-item.selected .result-arrow {
    opacity: 1;
  }
  
  /* -- search footer */
  .search-footer {
    padding: var(--space-sm) var(--space-lg);
    border-top: 1px solid var(--color-border);
    background-color: var(--color-bg-secondary);
  }
  
  .search-hint {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }
  
  .search-hint kbd {
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 10px;
    margin-right: 4px;
  }
</style>
